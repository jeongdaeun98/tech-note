# 브로커의 역할 -컨트롤러

## 컨트롤러 역할

파티션 리더를 선출하는 책임을 갖는다.

## 컨트롤러 특징

- 클러스터의 다수 브로커 중 한 대가 컨트롤러의 역할을 한다.
- 만약 컨트롤러 역할을 하는 브로커에 장애가 생기면 다른 브로커가 컨트롤러 역할을 한다.

### **컨트롤러 선출 과정**

1. 카프카 클러스터가 실행되면 **모든 브로커들은 최상위 노드에 /controller 임시 노드를 생성하려고 한다.**
2. 이 때 **가장 먼저 실행된 브로커가 /controller 임시 노드를 생성**하고 컨트롤러가 되며 나머지 브로커들은 ‘노드가 이미 존재한다’는 예외를 받고 이미 /controller 임시 노드가 있다는 것과 클러스터에 컨트롤러가 있다는 것을 알게 된다.
3. 이후에 **모든 브로커들은 /controller 노드에 주키퍼의 watch를 생성하여 controller 노드에 변화가 생기면 바로 알 수 있도록 한다**.

### 컨트롤러 재선출하는 과정?

1. 컨트롤러 브로커가 중단되거나 주키퍼와의 연결이 끊어지면 컨트롤러 노드가 삭제된다.
2. 해당 클러스터의 다른 브로커들이 주키퍼 watch를 통해 그를 알게 되고 컨트롤러 노드 생성을 시도한다.
3. 그 노드를 첫번째로 생성한 브로커가 컨트롤러가 된다. 컨트롤러는 매번 새로 선출될 때마다 주키퍼로부터 새로운 컨트롤러 세대 번호를 받는데, 따라서 변경 전의 컨트롤러와 혼동되지 않는다. 만일 이전 세대번호로 된 컨트롤러 메시지를 받으면 무시한다.

## 리더 선출 과정

### **장애 발생**

1. 주키퍼를 watch하여 특정 브로커에 장애가 생겼다는 것을 인지하면, 그 브로커 내 리더로 할당되었던 모든 파티션들에 새로운 리더가 필요하다는 것을 알게 된다.
2. 그 다음 컨트롤러는 새로운 리더를 필요로 하는 모든 파티션들을 점검하고 새로 리더가 될 브로커를 결정한다.
3. 특정 파티션이 새로운 리더를 갖는다는 것을 알리기 위해 새 리더와 팔로어들에게 **leaderAndIsr** 요청을 전송한다. 클라이언트 요청을 받아야한다는 것을 새 리더에게 알리고 팔로어들은 새 리더를 복제해야한다는 것을 알아야하기 때문이다.

### 자연스러운 서버 다운

![Untitled (6)](https://github.com/uneap/tech-note/assets/25525648/35585849-abea-48a6-a81a-18a576a88580)


1) 관리자가 브로커 종료 명령어를 실행하고 SIG_TERM 신호가 브로커에게 전달된다.

2)SIG_TERM 신호를 받은 브로커는 컨트롤러에게 알린다.

3) 컨트롤러는 리더 선출 작업을 진행하고 해당 정보를 주키퍼에 기록한다.

4) 컨트롤러는 새로운 리더 정보를 다른 브로커들에게 전송한다.

5) 컨트롤러는 종료 요청을 보낸 브로커에게 정상 종료를 해도 된다는 응답을 보낸다.

6) 응답을 받은 브로커는 캐시에 있는 내용을 디스크에 저장하고 종료한다.
