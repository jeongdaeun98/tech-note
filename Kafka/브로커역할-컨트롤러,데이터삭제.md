# 브로커의 역할 -컨트롤러, 데이터 삭제

## 컨트롤러 역할

파티션 리더를 선출하는 책임을 갖는다.

## 컨트롤러 특징

- 클러스터의 다수 브로커 중 한 대가 컨트롤러의 역할을 한다.
- 만약 컨트롤러 역할을 하는 브로커에 장애가 생기면 다른 브로커가 컨트롤러 역할을 한다.

### 선출 과정

1. 주키퍼를 watch하여 특정 브로커에 장애가 생겼다는 것을 인지하면, 그 브로커 내 리더로 할당되었던 모든 파티션들에 새로운 리더가 필요하다는 것을 알게 된다.
2. 그 다음 컨트롤러는 새로운 리더를 필요로 하는 모든 파티션들을 점검하고 새로 리더가 될 브로커를 결정한다.
3. 특정 파티션이 새로운 리더를 갖는다는 것을 알리기 위해 새 리더와 팔로어들에게 **leaderAndIsr** 요청을 전송한다. 클라이언트 요청을 받아야한다는 것을 새 리더에게 알리고 팔로어들은 새 리더를 복제해야한다는 것을 알아야하기 때문이다.

### 컨트롤러 선출하는 과정?

1. 컨트롤러 브로커가 중단되거나 주키퍼와의 연결이 끊어지면 컨트롤러 노드가 삭제된다.
2. 해당 클러스터의 다른 브로커들이 주키퍼 watch를 통해 그를 알게 되고 컨트롤러 노드 생성을 시도한다.
3. 그 노드를 첫번째로 생성한 브로커가 컨트롤러가 된다. 컨트롤러는 매번 새로 선출될 때마다 주키퍼로부터 새로운 컨트롤러 세대 번호를 받는데, 따라서 변경 전의 컨트롤러와 혼동되지 않는다. 만일 이전 세대번호로 된 컨트롤러 메시지를 받으면 무시한다.

## 데이터 삭제

- 카프카는 다른 메세징 플랫폼과 다르게 컨슈머가 데이터를 가져가더라도 토픽의 데이터는 삭제되지 않는다.
- 컨슈머나 프로듀서가 데이터 삭제를 요청할 수도 없다.
- 브로커만이 데이터를 삭제할 수 있다,
- 데이터 삭제는 파일 단위로 이루어지는데 이 단위를 ‘로그 세그먼트’라고 부른다. - **일정 시간이나 용량**에 따라 데이터 삭제
- 이 세그먼트에는 다수의 데이터가 들어 있기 때문에 일반적인 데이터베이스처럼 특정 데이터를 선별해서 삭제할 수 없다.
