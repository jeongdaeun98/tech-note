# 브로커의 역할 - 복제

- 장애 허용 시스템으로 동작하도록 하는 원동력이다.
- 클러스터로 묶인 브로커 중 일부에 장애가 발생하더라도 데이터를 유실하지 않고 안전하게 사용하기 위함.
- 데이터 복제는 파티션 단위로 이루어짐.
- 파티션의 복제 개수도 같이 설정되는데, 직접 옵션을 선택하지 않으면 브로커에 설정된 옵션 값을 따라감.
- 복제 개수의 최솟값은 1(복제 없음)이고 최댓값은 브로커 개수만큼 설정하여 사용할 수 있음. (보통 2~3으로 설정)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/97e7fb33-e85a-4373-9637-6efb979f1abe/Untitled.png)

- 복제된 파티션은 리더와 팔로워로 구성
- 복제: 팔로워 파티션들은 리더 파티션의 오프셋을 확인하여 자신이 가지고 있는 오프셋과 차이가 나는 경우 리더 파티션으로부터 데이터를 가져와 자신의 파티션에 저장
- 복제 개수 만큼 저장 용량이 증가함.
- 복제를 통해 데이터를 안전하게 사용할 수 있다는 강력한 장점때문에 카프카를 운영할 때 2 이상의 복제 개수를 정하는 것이 중요
- 서버는 해커로 인한 침입, 디스크 오류, 네트워크 연결 장애 등의 이유로 언제든 장애 발생 가능.

### 브로커에 장애가 발생한 경우

- 프로듀서가 데이터를 전송할 때 리더 파티션과만 통신하므로 데이터가 유실되지 않도록, 승급이 이뤄진다.
- 승급: 브로커가 다운되면 해당 브로커에 있는 리더 파티션은 사용할 수 없기에 팔로워 파티션 중 하나가 리더 파티션 지위를 넘겨 받는다.
- 운영 시 데이터 종류마다 다른 복제 개수를 설정하고 상황에 따라 토픽마다 복제 개수를 다르게 설정하여 운영함.
- 데이터가 일부 유실되어도 무관하고 데이터 처리 속도가 중요하다면 1, 2로 설정, 금융 정보와 같이 유실이 일어나면 안되는 데이터의 경우 복제 개수를 3으로 설정

### 파티션에 대해 리더 팔로워 동기화 과정이 어떻게 되나?

1. 리더는 팔로어 리플리카 중에 어떤 것이 최신 리더 메시지를 복제하고 있는지 알아야한다.
2. 리더와 동기화 하기 위해 리플리카들은 리더에게 fetch 요청을 전송한다. fetch 요청에는 리플리카가 다음으로 받기 원하는 메시지의 오프셋이 포함되며 항상 수신된 순서대로 처리된다.
3. 그럼 요청에 대한 응답으로 리더는 리플리카들에게 메시지를 전송한다.

> 예를 들면 팔로어 리플리카가 메시지 1 다음 메시지 2 다음 메시지 3을 요청하나 이 메시지를 모두 받기 전까지는 메시지 4를 요청하지 않을 수 있다. 즉 해당 리플리카가 메시지 4를 요청할 때는 메시지 3까지 모두 받았다는 것을 리더가 알 수 있다는 것을 의미한다.
> 
1. 따라서 각 팔로어 리플리카가 요청한 마지막 오프셋을 살펴보면 복제가 얼마나 지연되는지 리더는 알 수 있다. 지연 시간이 지정된 시간을 넘어섰을 경우 리플리카는 ISR(동기화 리플리카)에서 제외된다.
- 기존 리더가 중단되는 경우 동기화 리플리카만이 리더로 선출될 수 있다.

## ISR(In-Sync-Replicas)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f31e9e1f-3c51-4270-b18c-6d436cb1ccb5/Untitled.png)

- ISR은 리더 파티션과 팔로워 파티션이 모두 싱크가 된 상태

### unclean.leader.election.enable

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/24eead10-46d9-4189-878c-e839c26d9c29/Untitled.png)

리더 파티션의 데이터를 모두 복제하지 못한 상태일 때, 싱크가 되지 않은 팔로워 파티션이 리더 파티션으로 선출되면 데이터가 유실될 수 있다.

- unclean.leader.election.enable = true : 유실을 감수함. 복제가 안된 팔로워 파티션을 리더로 승급
- unclean.leader.elction.enable = false: 유실을 감수하지 않음. 해당 브로커가 복구될 때까지 중단.

false일 경우, 데이터를 지속적으로 처리하지 못하고 중단된 상태가 됨.

### 브로커 개수 별 차이

- 브로커 한대만 있을 경우, 브로커 한대에 장애가 나면 해당 브로커로부터 데이터를 가져올 수 없어 장애가 난다.
- 두대일 경우, 한대에 장애가 나면 한대의 브로커에서 읽고 쓰는데 문제가 없으나 추가적으로 복제된 데이터가 없음
- 세대일 경우, 한대에 장애가 나면 한대가 리더로 승격되고, 나머지 한대는 복제된 데이터가 존재하므로, 고가용성 확보

# ISR(In-Sync-Replicas)와 acks 옵션

## ISR

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/acf3d748-f638-4b9a-b173-dc26918af60e/Untitled.png)

- ISR은 replica가 1일 경우에도 존재한다. (리더 파티션에 데이터 도달 된 상태)
- ISR은 리더 파티션과 팔로워 파티션이 모두 싱크된 상태를 말한다.
- ISR 상태일 경우 리더 파티션이 위치한 브로커에 장애가 발생했을 때 fail over이다.
1. 프로듀서가 특정 파티션에 데이터를 저장하는 작업은 리더 파티션을 통해 처리
2. 리더 파티션에 새로운 레코드가 추가되어 오프셋이 증가하면 팔로워 파티션이 위치한 브로커는 리더 파티션의 데이터를 복제
3. 리더 파티션에 데이터가 적재된 이후 팔로워 파티션이 복제하는 시간차로 리더파티션과 팔로워 파티션 간에 오프셋 차이 발생

## acks

프로듀서가 전송한 데이터가 카프카 클러스터에 얼마나 신뢰성 높게 저장할지 지정할 수 있음.

복제 개수가 1인 경우 acks 옵션에 따른 성능 변화는 크지 않다.

그러나 복제 개수가 2 이상인 경우에 각 acks 별 동작 방식에 대해 알아본다.

성능을 높이고 신뢰성을 낮추거나 성능을 낮추고 신뢰성을 높이는 방식을 선택해야 함.

신뢰도 1,2,3  전송 속도 1,2,3이라 가정하면,

### 신뢰도 1, 전송 속도 3 : acks 0

- 프로듀서가 리더 파티션으로 데이터를 전송했을 때, 메시지 저장을 확인하지 않는다.
- acks를 1 이나 all로 했을 때보다 훨씬 빠르다.
- 데이터 일부 유실이 발생하더라도 전송 속도가 중요한 경우 이 옵션 값을 사용한다.
    - GPS 데이터 저장
- 이 경우 평소에는 메시지를 잘 받다가 브로커가 다운 되는 장애가 일어날 때 손실 가능성이 매우 높다.

### 신뢰도 2 , 전송 속도 2: acks 1

- 프로듀서가 보낸 데이터가 leader파티션에 제대로 적재되었을 경우 ack를 전송한다.
- 리더 파티션에 정상적으로 적재되지 않았을 경우 적재될 때까지 재시도 가능
- follower 파티션에 leader 메시지를 가져오기 전에 리더 파티션이 위치한 브로커에 장애가 발생할 경우 메시지 손실할 가능성이 있다.
    - 그러나 일반적으로 이럴일 잘 없으므로 1

### 신뢰도 3, 전송 속도 1 : acks  -1(all), 브로커의 min.insync.replicas

- 이 경우 프로듀서 데이터 처리량이 너무 낮아서 쓰기 어려움
- 프로듀서는 리더 파티션과 팔로워 파티션에 정상적으로 적재되었는지 확인
- 팔로우 파티션에 데이터가 정상 적재되었는지를 기다리므로 일부 브로커에 장애가 발생하더라도 프로듀서는 안전하게 데이터를 전송하고 저장할 수 있음을 보장함.
- 토픽 단위로 설정 가능한 min.insync.replicas 옵션에 따라 데이터의 안정성이 달라짐.

<aside>
💡 리더가 min.insync.replicas 이 옵션을 n개로 설정한다면, 1개의 리더파티션,  n - 1개의 follower 파티션이 정상 적재 되었는지를 검사한 뒤 ack를 보낸다.
그러나 replication과 동일하게 설정했을 경우, 브로커가 하나만 다운 되더라도 producer와 consumer와 통신할 수 없는 장애가 나게 된다.
따라서 카프카로 메시지를 보낼 수 없는 클러스터 전체 장애와 비슷한 상황이 발생한다.

</aside>

- min.insync.replicas의 옵션을 2개 이상으로 설정했을 때 all의 의미가 있다.
- 또한 옵션을 2로 설정하더라도, 실제 카프카 클러스터를 운영하며 브로커가 동시에 2개 중단되는 일은 극히 드물기 때문에 리더 파티션과 팔로워 파티션 중 1개 데이터가 적재 완료되었다면 데이터는 유실되지 않는다고 볼 수 있다.

### min.insync.replicas

- 해당 옵션은 프로듀서가 리더 파티션과 팔로워 파티션에 데이터가 적재되었는지 확인하기 위한 최소 ISR 그룹의 파티션 개수
- min.insync.replicas 옵션이 1일 경우, ISR 중 최소 1개 이상의 파티션에 데이터가 적재되었음을 확인함.
- 이 경우 acks 1로 설정했을 때와 동일, 리더파티션만이 프로듀서와 통신하니까, 결국 가장 처음 적재 완료 되는 파티션은 리더 파티션이므로.
- 해당 옵션은 replication보다 클 수 없다.