# 브로커의 역할 - 복제

- **장애 허용 시스템**으로 동작하도록 하는 원동력이다.
    - 클러스터로 묶인 브로커 중 일부에 장애가 발생하더라도 데이터를 유실하지 않고 안전성 유지
- 데이터 복제는 **파티션** 단위로 이루어짐.
- 복제된 파티션은 리더와 팔로워로 구성

### 복제 개수

- 토픽마다 복제 개수를 설정할 수 있는데, 직접 설정하지 않을 경우, 브로커에 설정된 값으로 설정됨.
- 복제 개수의 최솟값은 1(복제 없음)이고 최댓값은 브로커 개수만큼 설정하여 사용할 수 있음.
- 보통 고가용성 유지를 위해 2~3으로 설정
- 복제 개수 만큼 저장 용량이 증가
- 데이터가 일부 유실되어도 무관하고 데이터 처리 속도가 중요하다면 1, 2로 설정, 금융 정보와 같이 유실이 일어나면 안되는 데이터의 경우 복제 개수를 3으로 설정

### 브로커 개수 별 차이

- 브로커 한대만 있을 경우, 브로커 한대에 장애가 나면 해당 브로커로부터 데이터를 가져올 수 없어 장애가 난다.
- 두대일 경우, 한대에 장애가 나면 한대의 브로커에서 읽고 쓰는데 문제가 없음 그러나 다음 장애에 대한 fail over가 없음
- 세대일 경우, 한대에 장애가 나면 한대가 리더로 승격되고, 나머지 한대는 복제된 데이터가 존재하므로, 다음 장애에 대한 fail over 있음, 따라서 고가용성 확보
![Untitled](https://user-images.githubusercontent.com/25525648/219032230-987a866e-c933-4a6c-8f39-225fdb7d2d1a.png)

- 서버는 해커로 인한 침입, 디스크 오류, 네트워크 연결 장애 등의 이유로 언제든 장애 발생 가능.

### 파티션에 대해 리더 팔로워 동기화 과정이 어떻게 되나?

1. 프로듀서가 특정 파티션에 데이터를 저장하는 작업은 리더 파티션을 통해 처리
2.  리더 파티션에 새로운 레코드가 저장되어 오프셋이 증가하면 동기화를 위해 리플리카들은 리더에게 fetch 요청을 전송한다. fetch 요청에는 리플리카가 다음으로 받기 원하는 메시지 오프셋이 포함되며 항상 수신된 순서대로 처리된다.
3. 그럼 요청에 대한 응답으로 리더는 리플리카들에게 메시지를 전송한다. 따라서 각 팔로어 리플리카가 요청한 마지막 오프셋과 리더에 저장된 레코드의 최신 오프셋 차를 통해 복제가 얼마나 지연되는지 리더는 알 수 있다. 
    
    > 예를 들면 팔로어 리플리카가 메시지 1 다음 메시지 2 다음 메시지 3을 요청하나 이 메시지를 모두 받기 전까지는 메시지 4를 요청하지 못한다. 즉 해당 리플리카가 메시지 4를 요청할 때는 메시지 3까지 모두 받았다는 것을 리더가 알 수 있다는 것을 의미한다.
    > 
4. 리더 파티션에 레코드가 저장된 후 팔로워 파티션이 복제하는 시간 차가 지정된 시간을 넘어섰을 경우 (replica.lag.time.max.ms) 리플리카는 ISR(동기화 리플리카)에서 제외된다.

## ISR(In-Sync-Replicas)
![Untitled (1)](https://user-images.githubusercontent.com/25525648/219032266-b74f9971-34e2-4f07-bc99-aff274cc830f.png)


- ISR은 리더 파티션과 팔로워 파티션이 **모두 싱크**가 된 상태
- ISR은 replica가 1일 경우에도 존재 (리더 파티션에 데이터 도달 된 상태)
- ISR 상태일 경우 리더 파티션이 위치한 브로커에 장애가 발생했을 때 레코드가 유실되지 않고, 운영 가능

### 브로커에 장애가 발생한 경우

- 프로듀서가 데이터를 전송할 때 리더 파티션과만 통신하므로 데이터가 유실되지 않도록, 승급이 이뤄진다.
- 승급: 브로커가 다운되면 해당 브로커에 있는 리더 파티션은 사용할 수 없기에 팔로워 파티션 중 하나가 리더 파티션 지위를 넘겨 받는다.

### unclean.leader.election.enable
![Untitled (2)](https://user-images.githubusercontent.com/25525648/219032284-fda186c4-8c08-4ef1-a1a2-a67fa24c1473.png)


리더 파티션의 데이터를 모두 복제하지 못한 상태일 때, 싱크가 되지 않은 팔로워 파티션이 리더 파티션으로 선출되면 데이터가 유실될 수 있다.

- unclean.leader.election.enable = true : 유실을 감수함. 복제가 안된 팔로워 파티션을 리더로 승급
- unclean.leader.elction.enable = false: 유실을 감수하지 않음. 해당 브로커가 복구될 때까지 중단.

false일 경우, 데이터를 지속적으로 처리하지 못하고 중단된 상태가 됨.
